<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador de Documentos Acadêmicos - IPEN</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .campo-grupo[data-visible="false"] { display: none; }
        .flash-error { background-color: #f8d7da; color: #721c24; border-color: #f5c6cb; }
        .editor-container { position: relative; }
        .formatting-buttons {
            position: absolute; bottom: 100%; left: 0; margin-bottom: 6px;
            display: flex; gap: 6px; background-color: #e5e7eb;
            padding: 6px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); z-index: 10;
        }
        .format-btn { width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;
            border: 1px solid #d1d5db; background-color: #f9fafb; border-radius: 5px;
            font-size: 14px; cursor: pointer; transition: all 0.2s ease; }
        .format-btn:hover { background-color: #f3f4f6; border-color: #9ca3af; transform: scale(1.05); }
        .visual-editor {
            min-height: 42px; padding: 0.5rem 0.75rem; border: 1px solid #d1d5db; border-radius: 0.375rem;
            background-color: #f9fafb; box-shadow: inset 0 2px 4px 0 rgba(0,0,0,0.05);
        }
        .visual-editor[data-placeholder]:empty:before { content: attr(data-placeholder); color: #9ca3af; }
        .visual-editor sup { vertical-align: super; font-size: smaller; }
        .visual-editor sub { vertical-align: sub; font-size: smaller; }
        .hidden-textarea { display: none; }
    </style>
</head>
<body class="bg-gray-100 font-sans">

<div class="container mx-auto p-4 md:p-8 max-w-4xl">
    <header class="text-center mb-8">
        <img src="{{ url_for('static', filename='ipen_logo_azul.jpg') }}" alt="Logo IPEN" class="mx-auto h-20 mb-4">
        <h1 class="text-3xl font-bold text-gray-800">Gerador de Documentos Acadêmicos</h1>
        <p class="text-gray-600 mt-2">Preencha os campos abaixo para gerar os documentos do seu trabalho.</p>
    </header>

    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        {% for category, message in messages %}
            <div class="flash-{{ category }} p-4 mb-4 border rounded" role="alert">{{ message }}</div>
        {% endfor %}
    {% endif %}
    {% endwith %}

    <form id="main-form" action="/" method="POST" class="bg-white p-8 rounded-lg shadow-lg space-y-8">
        
        <!-- Seleção de documentos -->
        <fieldset class="border-t pt-6">
            <legend class="text-xl font-semibold text-gray-700 mb-4">1. Documentos para Gerar</legend>
            <div id="documentos-container" class="grid grid-cols-2 md:grid-cols-3 gap-4">
                {% for doc_id, doc_name in [('capa', 'Capa'), ('pagina_rosto', 'Página de Rosto'), ('ficha', 'Ficha Catalográfica'), ('resumo', 'Resumo'), ('abstract', 'Abstract'), ('contracapa', 'Contracapa')] %}
                <label class="flex items-center space-x-3 p-3 bg-gray-50 rounded-lg border hover:bg-gray-100 cursor-pointer">
                    <input type="checkbox" name="documentos" value="{{ doc_id }}" class="form-checkbox h-5 w-5 text-blue-600" checked>
                    <span>{{ doc_name }}</span>
                </label>
                {% endfor %}
            </div>
        </fieldset>

        <!-- Grupo: Nível e Área -->
        <fieldset class="campo-grupo" data-campos="nivel,area">
            <legend class="text-lg font-semibold text-gray-700">Curso</legend>
            <div class="campo-item" data-campo="nivel">
                <label for="nivel" class="block mb-1">Nível <span class="required-asterisk hidden text-red-600">*</span></label>
                <select id="nivel" name="nivel" class="w-full border rounded px-3 py-2">
                    <option value="">Selecione...</option>
                    <option value="Mestrado" {% if dados.get('nivel') == 'Mestrado' %}selected{% endif %}>Mestrado</option>
                    <option value="Mestrado Profissional" {% if dados.get('nivel') == 'Mestrado Profissional' %}selected{% endif %}>Mestrado Profissional</option>
                    <option value="Tese" {% if dados.get('nivel') == 'Tese' %}selected{% endif %}>Tese</option>
                </select>
            </div>
            <div class="campo-item" data-campo="area">
                <label for="area" class="block mb-1">Área <span class="required-asterisk hidden text-red-600">*</span></label>
                <select id="area" name="area" class="w-full border rounded px-3 py-2">
                    <option value="">Selecione...</option>
                </select>
            </div>
        </fieldset>

        <!-- Grupo: Autor -->
        <fieldset class="campo-grupo" data-campos="nome_completo,sobrenome,nome_citacao">
            <legend class="text-lg font-semibold text-gray-700">Autor</legend>
            <div class="campo-item" data-campo="nome_completo">
                <label for="nome_completo" class="block mb-1">Nome Completo <span class="required-asterisk hidden text-red-600">*</span></label>
                <input type="text" id="nome_completo" name="nome_completo" value="{{ dados.get('nome_completo','') }}" class="w-full border rounded px-3 py-2">
            </div>
            <div class="campo-item" data-campo="sobrenome">
                <label for="sobrenome" class="block mb-1">Sobrenome</label>
                <input type="text" id="sobrenome" name="sobrenome" value="{{ dados.get('sobrenome','') }}" class="w-full border rounded px-3 py-2">
            </div>
            <div class="campo-item" data-campo="nome_citacao">
                <label for="nome_citacao" class="block mb-1">Nome para Citação</label>
                <input type="text" id="nome_citacao" name="nome_citacao" value="{{ dados.get('nome_citacao','') }}" class="w-full border rounded px-3 py-2">
            </div>
        </fieldset>

        <!-- Grupo: Título -->
        <fieldset class="campo-grupo" data-campos="titulo,subtitulo,titulo_traduzido">
            <legend class="text-lg font-semibold text-gray-700">Título</legend>
            <div class="campo-item" data-campo="titulo">
                <label for="titulo" class="block mb-1">Título <span class="required-asterisk hidden text-red-600">*</span></label>
                <input type="text" id="titulo" name="titulo" value="{{ dados.get('titulo','') }}" class="w-full border rounded px-3 py-2">
            </div>
            <div class="campo-item" data-campo="subtitulo">
                <label for="subtitulo" class="block mb-1">Subtítulo</label>
                <input type="text" id="subtitulo" name="subtitulo" value="{{ dados.get('subtitulo','') }}" class="w-full border rounded px-3 py-2">
            </div>
            <div class="campo-item" data-campo="titulo_traduzido">
                <label for="titulo_traduzido" class="block mb-1">Título em Inglês</label>
                <input type="text" id="titulo_traduzido" name="titulo_traduzido" value="{{ dados.get('titulo_traduzido','') }}" class="w-full border rounded px-3 py-2">
            </div>
        </fieldset>

        <!-- Grupo: Orientadores -->
        <fieldset class="campo-grupo" data-campos="orientador,orientador_tipo,coorientador,coorientador_tipo">
            <legend class="text-lg font-semibold text-gray-700">Orientação</legend>
            <div class="campo-item" data-campo="orientador_tipo">
                <label for="orientador_tipo" class="block mb-1">Tipo do Orientador</label>
                <select id="orientador_tipo" name="orientador_tipo" class="w-full border rounded px-3 py-2">
                    <option value="">Selecione...</option>
                    <option value="Prof. Dr." {% if dados.get('orientador_tipo') == "Prof. Dr." %}selected{% endif %}>Prof. Dr.</option>
                    <option value="Profa. Dra." {% if dados.get('orientador_tipo') == "Profa. Dra." %}selected{% endif %}>Profa. Dra.</option>
                </select>
            </div>
            <div class="campo-item" data-campo="orientador">
                <label for="orientador" class="block mb-1">Nome do Orientador <span class="required-asterisk hidden text-red-600">*</span></label>
                <input type="text" id="orientador" name="orientador" value="{{ dados.get('orientador','') }}" class="w-full border rounded px-3 py-2">
            </div>
            <div class="campo-item" data-campo="coorientador_tipo">
                <label for="coorientador_tipo" class="block mb-1">Tipo do Coorientador</label>
                <select id="coorientador_tipo" name="coorientador_tipo" class="w-full border rounded px-3 py-2">
                    <option value="">Selecione...</option>
                    <option value="Prof. Dr." {% if dados.get('coorientador_tipo') == "Prof. Dr." %}selected{% endif %}>Prof. Dr.</option>
                    <option value="Profa. Dra." {% if dados.get('coorientador_tipo') == "Profa. Dra." %}selected{% endif %}>Profa. Dra.</option>
                </select>
            </div>
            <div class="campo-item" data-campo="coorientador">
                <label for="coorientador" class="block mb-1">Nome do Coorientador</label>
                <input type="text" id="coorientador" name="coorientador" value="{{ dados.get('coorientador','') }}" class="w-full border rounded px-3 py-2">
            </div>
        </fieldset>

        <!-- Grupo: Informações adicionais -->
        <fieldset class="campo-grupo" data-campos="ano,paginas,versao,licenca,idioma,chaves_keywords">
            <legend class="text-lg font-semibold text-gray-700">Informações</legend>
            <div class="campo-item" data-campo="ano">
                <label for="ano" class="block mb-1">Ano <span class="required-asterisk hidden text-red-600">*</span></label>
                <input type="text" id="ano" name="ano" value="{{ dados.get('ano','') }}" class="w-full border rounded px-3 py-2">
            </div>
            <div class="campo-item" data-campo="paginas">
                <label for="paginas" class="block mb-1">Número de Páginas</label>
                <input type="text" id="paginas" name="paginas" value="{{ dados.get('paginas','') }}" class="w-full border rounded px-3 py-2">
            </div>
            <div class="campo-item" data-campo="versao">
                <label for="versao" class="block mb-1">Versão</label>
                <select id="versao" name="versao" class="w-full border rounded px-3 py-2">
                    <option value="">Selecione...</option>
                    <option value="Versão Original" {% if dados.get('versao') == "Versão Original" %}selected{% endif %}>Versão Original</option>
                    <option value="Versão Corrigida" {% if dados.get('versao') == "Versão Corrigida" %}selected{% endif %}>Versão Corrigida</option>
                </select>
            </div>
            <div class="campo-item" data-campo="licenca">
                <label for="licenca" class="block mb-1">Licença</label>
                <input type="text" id="licenca" name="licenca" value="{{ dados.get('licenca','') }}" class="w-full border rounded px-3 py-2">
            </div>
            <div class="campo-item" data-campo="idioma">
                <label for="idioma" class="block mb-1">Idioma</label>
                <select id="idioma" name="idioma" class="w-full border rounded px-3 py-2">
                    <option value="">Selecione...</option>
                    <option value="Português" {% if dados.get('idioma') == "Português" %}selected{% endif %}>Português</option>
                    <option value="Inglês" {% if dados.get('idioma') == "Inglês" %}selected{% endif %}>Inglês</option>
                </select>
            </div>
            <div class="campo-item" data-campo="chaves_keywords">
                <label for="chaves_keywords" class="block mb-1">Palavras-chave</label>
                <input type="text" id="chaves_keywords" name="chaves_keywords" value="{{ dados.get('chaves_keywords','') }}" class="w-full border rounded px-3 py-2">
            </div>
        </fieldset>

        <!-- Grupo: Resumos -->
        <fieldset class="campo-grupo" data-campos="resumo,abstract">
            <legend class="text-lg font-semibold text-gray-700">Resumos</legend>
            <div class="campo-item" data-campo="resumo">
                <label for="resumo" class="block mb-1">Resumo em Português</label>
                <div class="editor-container">
                    <div id="resumo_editor" class="visual-editor" contenteditable="true" data-placeholder="Digite o resumo...">{{ dados.get('resumo','')|safe }}</div>
                    <textarea id="resumo" name="resumo" class="hidden-textarea">{{ dados.get('resumo','') }}</textarea>
                </div>
            </div>
            <div class="campo-item" data-campo="abstract">
                <label for="abstract" class="block mb-1">Abstract em Inglês</label>
                <div class="editor-container">
                    <div id="abstract_editor" class="visual-editor" contenteditable="true" data-placeholder="Digite o abstract...">{{ dados.get('abstract','')|safe }}</div>
                    <textarea id="abstract" name="abstract" class="hidden-textarea">{{ dados.get('abstract','') }}</textarea>
                </div>
            </div>
        </fieldset>

        <!-- Botão -->
        <div class="border-t pt-6 text-center">
            <button type="submit" class="bg-blue-700 hover:bg-blue-800 text-white font-bold py-3 px-8 rounded-lg shadow-md transition-transform transform hover:scale-105">Gerar Documentos</button>
        </div>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const CAMPOS_POR_DOCUMENTO = {
        capa: ["nivel","area","nome_completo","sobrenome","titulo","subtitulo","ano","orientador_tipo","orientador"],
        pagina_rosto: ["versao","nivel","area","nome_completo","sobrenome","titulo","subtitulo","ano","orientador_tipo","orientador","coorientador_tipo","coorientador"],
        ficha: ["licenca","idioma","nivel","area","nome_citacao","nome_completo","sobrenome","titulo","subtitulo","ano","paginas","orientador_tipo","orientador","coorientador_tipo","coorientador","chaves_keywords"],
        resumo: ["idioma","nivel","area","nome_citacao","titulo","titulo_traduzido","ano","paginas","chaves_keywords","resumo"],
        abstract: ["idioma","nivel","area","nome_citacao","titulo","titulo_traduzido","ano","paginas","chaves_keywords","abstract"],
        contracapa: ["nivel"]
    };

    const CAMPOS_OBRIGATORIOS_BASE = {
        capa: ["nivel","area","nome_completo","titulo","ano"],
        pagina_rosto: ["nivel","area","nome_completo","titulo","ano","orientador"],
        ficha: ["nivel","area","nome_citacao","titulo","ano","paginas","orientador","chaves_keywords"],
        resumo: ["nivel","area","titulo","ano","resumo"],
        abstract: ["nivel","area","titulo","ano","abstract"],
        contracapa: ["nivel"]
    };

    const form = document.getElementById('main-form');
    const checkboxes = document.querySelectorAll('input[name="documentos"]');
    const grupos = document.querySelectorAll('.campo-grupo');

    function atualizarVisibilidade() {
        const selecionados = Array.from(checkboxes).filter(c => c.checked).map(c => c.value);
        const camposVisiveis = new Set();
        const camposObrigatorios = new Set();

        selecionados.forEach(doc => {
            (CAMPOS_POR_DOCUMENTO[doc] || []).forEach(campo => camposVisiveis.add(campo));
            (CAMPOS_OBRIGATORIOS_BASE[doc] || []).forEach(campo => camposObrigatorios.add(campo));
        });

        grupos.forEach(grupo => {
            let algumVisivel = false;
            grupo.querySelectorAll('.campo-item').forEach(item => {
                const campo = item.getAttribute('data-campo');
                if (camposVisiveis.has(campo)) {
                    item.style.display = '';
                    algumVisivel = true;
                    const asterisco = item.querySelector('.required-asterisk');
                    if (asterisco) {
                        if (camposObrigatorios.has(campo)) {
                            asterisco.classList.remove('hidden');
                        } else {
                            asterisco.classList.add('hidden');
                        }
                    }
                } else {
                    item.style.display = 'none';
                }
            });
            grupo.style.display = algumVisivel ? '' : 'none';
        });
    }

    checkboxes.forEach(c => c.addEventListener('change', atualizarVisibilidade));
    atualizarVisibilidade();

    document.querySelectorAll('.visual-editor').forEach(editor => {
        const textarea = editor.nextElementSibling;
        editor.addEventListener('input', () => textarea.value = editor.innerHTML);
    });
});
</script>
</body>
</html>